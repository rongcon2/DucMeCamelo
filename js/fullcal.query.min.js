var Server = 'http://ducme-camelo.rhcloud.com/index.php';
var dbTables = new Array('CAMELO-JAN', 'CAMELO-FEB', 'CAMELO-MAR', 'CAMELO-APR', 'CAMELO-MAY', 'CAMELO-JUN', 'CAMELO-JUL', 'CAMELO-AUG', 'CAMELO-SEP', 'CAMELO-OCT', 'CAMELO-NOV', 'CAMELO-DEC');
var holidayColor = '#df9fbf';
var activityColor = '#99e600';
var events = [];
var Calendar = new Date();
var curyear = Calendar.getFullYear();  // Returns current year
//var curmonth = Calendar.getMonth();    // Returns month (0-11)   
var startWeekDay;// = Calendar.getDay();    // Returns day of teh week (0-6) 
var defaultDate;// = Calendar.getFullYear() + "-" + prefix + (Calendar.getMonth() + 1) + "-01";
var monthCnt = 0;
var day_of_week = [['thứ hai', ' thứ ba', ' thứ tư', 'thứ năm', 'thứ sáu', 'thứ bảy', 'chúa nhật'],
    ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'],
    ['lunes', 'martes', 'miércoles', 'jueves', 'viernes', 'sábado', 'domingo']];
var fullCalLanguage = "vi"; // default vietnamese
var daynames;

function initFullcal(lang) {
    events = new Array();
    monthCnt = 0;
    fullCalLanguage = lang;
    // console.log(fullCalLanguage);
    if (fullCalLanguage.localeCompare('vi') === 0) {
        daynames = day_of_week[0];
    }
    if (fullCalLanguage.localeCompare('en') === 0) {
        daynames = day_of_week[1];
    }
    if (fullCalLanguage.localeCompare('es') === 0) {
        daynames = day_of_week[2];
    }
    if ((Calendar.getMonth() + 1) < 10)
        defaultDate = Calendar.getFullYear() + "-0" + (Calendar.getMonth() + 1) + "-01";
    else
        defaultDate = Calendar.getFullYear() + "-" + (Calendar.getMonth() + 1) + "-01";

//  window.onload = function () {
    for (var id = 0; id < dbTables.length; id++) { // get all 12 months
        Calendar = new Date();
        Calendar.setDate(1);    // Start the calendar day at '1'
        Calendar.setMonth(id);    // Start the calendar month at now
        startWeekDay = Calendar.getDay();    // Returns day of teh week (0-6)
        var param = "code=0&index=1&colname=1&text=empty&table=" + dbTables[Calendar.getMonth()] + "&mode=manage";
        accessDB(param, startWeekDay);
    }

}

function accessDB(param, startWeekDay) {
    setTimeout(function () { // delay 
        // console.log("accessDatabase  " + param);
        $.post(Server, {"LICH": param}, function (data) { // sending ajax post request
            var temp = JSON.stringify(data);
            //console.log(temp);
            setupMonth(JSON.parse(temp), startWeekDay);
            monthCnt++;
            if (monthCnt === dbTables.length) { // make sure to get data for all 12 months first
                displayFullCal();
            }
        });
    }, 50);
}

function setupMonth(array, startWeekDay) {
    for (var idx = startWeekDay - 1; idx < array.length; idx++) {
        if (typeof (array[idx]) !== "undefined") {
            var r = array[idx].split('|');
            for (var i = 0; i < r.length; i++) {
                //console.log(r[i]);
                var s = r[i].split(',');
                if (s.length === 3) {
                    if (s[0].localeCompare('Activity') === 0) // with no end time
                        events.push({title: getTitle(s[1].split(';')), start: s[2], color: activityColor});
                    else {// holidays
                        // console.log(s);
                        events.push({title: getTitle(s[1].split(';')), start: s[2], allDay: true, color: holidayColor});
                    }
                }
                if (s.length === 4) // with end time
                    events.push({title: getTitle(s[1].split(';')), start: s[2], end: s[3], color: activityColor});
            }
        }
    }
}

function getTitle(u) {
    var title = "";
    if (fullCalLanguage.localeCompare('vi') === 0) {
        title = u[0];
    }
    if (fullCalLanguage.localeCompare('en') === 0) {
        title = u[1];
    }
    if (fullCalLanguage.localeCompare('es') === 0) {
        title = u[2];
    }
    return title;
}

function displayFullCal() {
    //console.log("displayFullCal  "+fullCalLanguage);
    $('#calendar').fullCalendar({
        header: {
            left: 'prev,next today',
            center: 'title',
            right: 'month,agendaWeek,agendaDay'
        },
        columnFormat: {// get full names instead of short
            month: 'dddd', // Monday, Wednesday, etc
            week: 'dddd, MMM dS', // Monday 9/7
            day: 'dddd, MMM dS'  // Monday 9/7
        },
        lang: fullCalLanguage,
        defaultDate: defaultDate,
        businessHours: true, // display business hours
        editable: true,
        events: events,
        theme: false,
        disableDragging: true,
        eventMouseover: function (event, jsEvent, view) {
            if (view.name !== 'agendaDay') {
                $(jsEvent.target).attr('title', event.title);
            }
        }
    });

    $(".fc-prev-button span").click(function () {
        //var view = $('#calendar').fullCalendar('getView');
        //console.log("The PREV view's title is " + view.intervalStart.format());
        //console.log("The PREV view's title is " + view.name);
        //$('#calendar').fullCalendar('gotoDate', '2016-05-01');
        var date = $('#calendar').fullCalendar('getDate');
        console.log(curyear);
        if (new Date(date.format()) < new Date(curyear + '-01-02'))
            return false; // disallow
        date = $('#calendar').fullCalendar('getDate');
        var month = (new Date(date.format())).getMonth();
        document.getElementById("monthBox").selectedIndex = month;
        return true; // enable change month
    });

    $(".fc-next-button span").click(function () {
        var date = $('#calendar').fullCalendar('getDate');
        //  if (new Date(date.format()) > new Date(curyear + '-12-30'))
        //      return false; // disallow
        //  date = $('#calendar').fullCalendar('getDate');
        //console.log(date.format());
        var m = (date.format()).split('-');
        //console.log(m[1]);
        if (Number(m[1]) === 12)
            return false; // disallow
        document.getElementById("monthBox").selectedIndex = Number(m[1]);
        return true; // enable change month
    });

    $(".fc-today-button").click(function () {
        var date = $('#calendar').fullCalendar('getDate');
        //console.log(date.format());
        var month = (new Date(date.format())).getMonth();
        document.getElementById("monthBox").selectedIndex = month;
    });
}
 